id: gitverified-main-pipeline
namespace: ai.gitverified

inputs:
  - name: candidate_name
    type: STRING
    defaults: "John Doe"
  - name: pdf_path
    type: STRING
    defaults: "/app/agents/data/resume.pdf"
  - name: github_reponame
    type: STRING
    defaults: "mock_user/project-alpha"
  - name: leetcode_username
    type: STRING
    defaults: "mock_coder"
  - name: job_description
    type: STRING
    defaults: "Senior React Developer with Python experience..."

tasks:
  # 1. INTEGRITY SCAN
  - id: run-integrity
    type: io.kestra.plugin.scripts.python.Commands
    runner: DOCKER
    docker:
      image: gitverified-backend_python-worker:latest
      pullPolicy: NEVER
      volumes:
        - c:/Users/lenovo/RealEngineers.ai/gitverified-backend/agents:/app/agents
    commands:
      - python3 /app/agents/agent_integrity.py "{{ inputs.pdf_path }}" > "{{ inputs.pdf_path }}.integrity.json"

  # 2. PARALLEL ANALYSIS
  - id: parallel-agents
    type: io.kestra.core.tasks.flows.Parallel
    tasks:
      - id: run-algo
        type: io.kestra.plugin.scripts.python.Commands
        runner: DOCKER
        docker:
          image: gitverified-backend_python-worker:latest
          pullPolicy: NEVER
          volumes:
            - c:/Users/lenovo/RealEngineers.ai/gitverified-backend/agents:/app/agents
        commands:
          - python3 /app/agents/agent_algo.py "{{ inputs.leetcode_username }}" > "{{ inputs.pdf_path }}.algo.json"

      - id: run-oumi
        type: io.kestra.plugin.scripts.python.Commands
        runner: DOCKER
        docker:
          image: gitverified-backend_python-worker:latest
          pullPolicy: NEVER
          volumes:
            - c:/Users/lenovo/RealEngineers.ai/gitverified-backend/agents:/app/agents
        commands:
          - python3 /app/agents/agent_oumi.py "{{ inputs.github_reponame }}" > "{{ inputs.pdf_path }}.oumi.json"

      - id: run-security-audit
        type: io.kestra.plugin.scripts.python.Commands
        runner: DOCKER
        docker:
          image: gitverified-backend_python-worker:latest
          pullPolicy: NEVER
          volumes:
            - c:/Users/lenovo/RealEngineers.ai/gitverified-backend/agents:/app/agents
        commands:
          - python3 /app/agents/agent_sentinel.py "{{ inputs.github_reponame }}" > "{{ inputs.pdf_path }}.sentinel.json"

      - id: run-relevance
        type: io.kestra.plugin.scripts.python.Commands
        runner: DOCKER
        docker:
          image: gitverified-backend_python-worker:latest
          pullPolicy: NEVER
          volumes:
            - c:/Users/lenovo/RealEngineers.ai/gitverified-backend/agents:/app/agents
        commands:
          - python3 /app/agents/agent_relevance.py "{{ inputs.pdf_path }}" "{{ inputs.job_description }}" > "{{ inputs.pdf_path }}.relevance.json"

  # 3. FINAL DECISION ENGINE
  - id: decision-engine
    type: io.kestra.plugin.scripts.python.Script
    runner: DOCKER
    docker:
      image: python:3.9-slim
      volumes:
        - c:/Users/lenovo/RealEngineers.ai/gitverified-backend/agents:/app/agents
    script: |
      import json
      import os

      base_path = "{{ inputs.pdf_path }}"
      
      def load_json(suffix):
          p = f"{base_path}.{suffix}.json"
          if os.path.exists(p):
              try:
                  with open(p) as f: return json.load(f)
              except: return {}
          return {}

      integrity = load_json("integrity")
      algo = load_json("algo")
      sentinel = load_json("sentinel")
      relevance = load_json("relevance")
      oumi = load_json("oumi")
      
      i_score = integrity.get('integrity_score', 0)
      a_score = algo.get('score', 0)
      s_score = sentinel.get('score', 100)
      r_score = relevance.get('match_score', 0)
      o_score = (oumi.get('score', 5.0) / 10.0) * 100
      
      total = (i_score * 0.25) + (a_score * 0.20) + (r_score * 0.25) + (s_score * 0.15) + (o_score * 0.15)
      
      ai_summary = f"Candidate shows {algo.get('verdict', 'UNKNOWN')} algorithm performance (Score: {a_score:.1f}/100) with project uniqueness of {oumi.get('score', 5.0):.1f}/10. Overall assessment: {'PASS' if total > 80 else 'FAIL' if total < 50 else 'REVIEW'}."
      
      final_data = {
          "status": "complete",
          "score": int(total),
          "verdict": "PASS" if total > 80 else "FAIL" if total < 50 else "REVIEW",
          "kestra_summary": ai_summary,
          "details": {
              "integrity": i_score,
              "algo": a_score,
              "relevance": r_score,
              "security": s_score,
              "uniqueness": o_score
          }
      }

      with open(f"{base_path}.final.json", "w") as f:
          json.dump(final_data, f, indent=2)
      
      print(json.dumps(final_data, indent=2))

